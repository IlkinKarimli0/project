positive_data = {'yes':'bəli',  'tamamdir':'bəli', 'tamamdır':'bəli', 'beli':'bəli',  'bəli':'bəli',   'belli':'bəli',  'aha':'bəli',  'hə':'bəli',  'he':'bəli',
                 'elədir':'elədir',  'eledir':'elədir','heeeeeee':'bəli',
                 'doğrudur':'doğrudur',  'dogrudur':'doğrudur',  'doğru':'doğru',  'dogru':'doğru',
                 'edilmişəm':'edilmişəm',   'edilmishem':'edilmişəm',   'edilib':'edilib',   'edilif':'edilib',
                 'əliləm':'əliləm',   'elilem':'əliləm','heee':'bəli','heeeeeeeee':'bəli',
                 'dayandırılıb':'dayandırılıb',   'dayandirilib':'dayandırılıb',   'diyandirilib':'dayandırılıb',   'diyandırılıb':'dayandırılıb',
                 'yaşına':'yaşına',   'yashina':'yaşına',
                 'çatmışam':'çatmışam',    'catmisham':'çatmışam',
                 'işləyirəm':'işləyirəm',   'ishleyirem':'işləyirəm',    'ishdiyirem':'işləyirəm',  'ishteyirem':'işləyirəm',
                 'əlaqəlidir':'əlaqəlidir',   'elaqəlidir':'əlaqəlidir',     'var':'var',
                 'çatıb':'catıb',      'catib':'catıb',     'catif':'catıb',
                 'olmuşam':'olmuşam',     'olmusham':'olmuşam',
                 'olunub':'olunub','olunuf':'olunub',
                 'dəyişib':'dəyişib','deyishib':'dəyişib','deyisib':'dəyişib',
                 'gedib':'gedib',
                 'edilibdir':'edilibdir','cixarilmishdi':'bəli','çıxarılmışdı':'bəli',
                 'edilib':'edilib','gedib':'bəli','rəhmətə':'bəli','rehmete':'bəli',
                 'olub':'olub',
                 'edilmişəm':'edilmişəm','edilmishem':'edilmişəm',
                 'kəsilib':'kəsilib','kesilib':'kəsilib',
                 'böyükdür':'böyükdür','boyukdur':'böyükdür',
                 'böyükəm':'böyükəm','boyukem':'böyükəm',
                 'göstərirəm':'göstərirəm','gosterirem':'göstərirəm',
                 'baxıram':'baxıram','baxiram':'baxıram',
                 'himayəmdədir':'himayəmdədir','himayemdedir':'himayəmdədir',
                 'mövcuddur':'mövcuddur','movcuddur':'mövcuddur',
                 'yox':'xeyr',     'xeyir':'xeyr',       'nope':'xeyr',        'net':'xeyr',      'no':'xeyr', 'yo':'xeyr',
                 'elə':'elə','ele':'elə','yooooo':'xeyr',
                 'deyil':'deyil','yoo':'xeyr',
                 'nə':'nə','ne':'nə','tapir':'tapır','tapiram':'tapır','tapib':'tapır',
                 'bilməz':'bilməz','bilmez':'bilməz',
                 'olunmayıb':'olunmayıb','olunmayib':'olunmayıb',
                 'kəsilməyib':'kəsilməyib','kesilmeyib':'kəsilməyib',
                 'olmamışam':'olmamışam','olmamisham':'olmamışam','olmuyub':'olmamışam',
                 'yoxdur':'yoxdur',
                 'çatmayıb':'çatmayıb',   'chatmayib':'çatmayıb',
                 'göstərmirəm':'göstərmirəm',   'gostermirem':'göstərmirəm',
                 'kiçiyəm':'kiçiyəm','kichiyem':'kiçiyəm',
                 'kiçik':'kiçik','kichik':'kiçik','kicik':'kiçik',
                 'gəlmir':'gəlmir','gelmir':'gəlmir',
                 'danışırsan':'danışırsan','danishirsan':'danışırsan','danisirsan':'danışırsan',
                 'bilməz':'bilməz','bilmez':'bilməz','bilməs':'bilməz','bilmes':'bilməz','yoxe':'xeyr',
                 'edilməmişəm':'edilməmişəm','edilmemishem':'edilməmişəm','edilmemisem':'edilməmişəm',
                 'edilməyib':'edilməyib','edilmeyib':'edilməyib',
                 'dayandırılmayıb':'dayandırılmayıb','dayandirilmayib':'dayandırılmayıb',
                 'çatmamışam':'çatmamışam','catmamisham':'çatmamışam','chatmamisham':'çatmamışam','catmamisam':'çatmamışam',
                 'yaşına':'yaşına','yasina':'yaşına','yashina':'yaşına',
                 'işləmirəm':'işləmirəm','ishlemirem':'işləmirəm','islemirem':'işləmirəm',
                 'yoxdur':'xeyr','yoxdu':'xeyr',
                 'çatmayıb':'çatmayıb','catmayib':'çatmayıb','chatmayib':'çatmayıb',
                 'əlil':'əlil','elil':'əlil',
                 'deyil':'xeyr','getmeyib':'xeyr','getməyib':'xeyr','tapmir':'xeyr','tapmır':'xeyr','cixarilmamishdi':'xeyr','cixarilmayib':'xeyr',
                 'vermiyib':'xeyr','vermeyib':'xeyr','verilmiyib':'xeyr','vermeyib':'xeyr','verib':'bəli','cixib':'bəli','verilib':'bəli','vermisem':'bəli',
                 'üçüncü':'üçüncü','ucuncu':'üçüncü','cıxarılmamışdı':'xeyr','cıxarılmayıb':'xeyr','catmamisam':'xeyr','catmisam':'bəli','cixmisam':'bəli',
                 'cixmamisam':'xeyr','vermemisem':'xeyr',
                 'ikinci':'ikinci',
                 'aşağı':'aşağı','asagi':'aşağı',
                 'işsizəm':'işsizəm','issizem':'işsizəm',
                 'işləmirəm':'işləmirəm','ishlemirem':'işləmirəm','islemirem':'işləmirəm',
                 'itirməyib':'itirməyib','itirmeyib':'itirməyib',
                 'kəsilməyib':'kəsilməyib','kesilmeyib':'kəsilməyib',
                 'baxmıram':'baxmıram','baxmiram':'baxmıram',
                 'deyiləm':'deyiləm','deyilem':'deyiləm',
                 'ölümdən':'ölümdən','olumden':'ölümdən','sagdir':'xeyr','sağdır':'xeyr','yaşayır':'xeyr','yashayir':'xeyr',
                 'edilməmişəm': 'edilməmişəm','edilmemishem':'edilməmişəm','edilmemisem': 'edilməmişəm',
                 'müəyyən':'müəyyən','mueyyen':'müəyyən','movcud':'mövcud','movcut':'mövcud',
                        'hərbi':'hərbi','herbi':'hərbi',
                        'xidmət':'xidmət','xidmet':'xidmət',
                        'aldığı':'aldığı','aldiqi':'aldığı',
                        'xəsarət':'xəsarət','xəsaret':'xəsarət',
                        'əlaqədar':'əlaqədar','elaqedar':'əlaqədar',
                        'rəhmətə':'rəhmətə','rehmete':'rəhmətə',
                        'rütbədən':'rütbədən', 'rutbəden':'rütbədən',
                        'pensiya':'pensiya',
                        'yaşına':'yaşına','yashina':'yaşına',
                        'dərəcə':'dərəcə','derece':'dərəcə',
                        'mən':'mən','men':'mən',
                        'müəyyən':'müəyyən','mueyyen':'müəyyən',
                        'meyyen':'müəyyən',
                        'məhrum':'məhrum','mehrum':'məhrum',
                        'hərbiçi':'hərbiçi','herbichi':'hərbiçi',
                        'rütbədən':'rütbədən','rutbeden':'rütbədən',
                        'aşkar':'aşkar','ashkar':'aşkar','askar':'aşkar',
                        'yerdə':'yerdə','yerde':'yerdə',
                        'əlaqəli':'əlaqəli','elaqeli':'əlaqəli',
                        'dərəcədir':'dərəcədir','derecedir':'dərəcədir',
                        'uyğun':'uyğun','uyqun':'uyğun'
                 }

eliminate_list = ['mence','məncə','movcud','vefat','rəhmətə','rehmete']
fallback_list = ['salam','necesen','ne bilim','bilmirem','nem']
                 


# TODO check whether you should add "davam edir"

# TODO <NUMBIG> <NUMSMALL> detection

# TODO clean suffixs dan den % ni nu 




import tensorflow as tf
from vectorize import text_to_vector
import numpy as np;import json
from tokenizer import tokenize
from difflib import get_close_matches
import os
from fastapi import FastAPI
from pydantic import BaseModel

curr_dir = os.path.dirname(os.path.abspath(__file__))





app = FastAPI()

class TextData(BaseModel):
    text: str

@app.post("/api/yesnt/text")
async def process_text(text_data: TextData):
    text = text_data.text

    response_data = main_func(text)
    
    print(type(response_data))

    return {"answer": response_data}




def to_correct(inpt_text,probs):
    new_input_text = []

    for word in inpt_text.split(' '):

        if word not in eliminate_list:
        
            corrected = get_close_matches(word,list(probs.keys()),cutoff=0.85)
            if corrected:
                new_input_text.append(probs[corrected[0]])
            else:
                new_input_text.append(word)

    return ' '.join(new_input_text)


id_to_cls_path = os.path.join(curr_dir,"id_to_cls.txt")
bert_path = os.path.join(curr_dir,'bert_fc_classifier')


with open(id_to_cls_path, "r") as fp:
    # Load the dictionary from the file
    id_to_cls = json.load(fp)

modelo = tf.keras.models.load_model(bert_path)


def main_func(text):

    text = tokenize(text)

    text = to_correct(text,positive_data)

    embedding = text_to_vector(text)

    model_output = modelo.predict(embedding.reshape(1,768))
    
    fallback = get_close_matches(text,fallback_list,cutoff = 0.85)
    if not fallback:

        if model_output[0][np.argmax(model_output)]>0.8:
            if id_to_cls [ str(np.argmax(model_output) +1)] =="Bəli":
                return 'YES'
            if id_to_cls [ str(np.argmax(model_output) +1)] =="Xeyr":
                return 'NO'
        else:
            return None
    else:
        return None
    
print(main_func('beli beli ishsizem'))




